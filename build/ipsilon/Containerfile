FROM quay.io/fedora/fedora:41
# should be specified as hostname:port to listen on a non-standard port
ARG hostname=ipsilon.tinystage.test
RUN curl -o /etc/yum.repos.d/infra-tags.repo https://pagure.io/fedora-infra/ansible/raw/main/f/files/common/fedora-infra-tags.repo

RUN dnf install -y \
	ipsilon \
        ipsilon-tools-ipa \
	ipsilon-openid \
	ipsilon-openidc \
	ipsilon-authgssapi \
	ipsilon-authform \
	ipsilon-authpam \
	ipsilon-infosssd \
	ipsilon-infofas \
	ipsilon-theme-Fedora \
	mod_auth_openidc \
	mod_auth_gssapi \
	python3-pam \
	python3-dbus \
	python3-freeipa \
	freeipa-client \
	krb5-workstation \
	patch git sed systemd procps-ng elinks
RUN git clone https://pagure.io/fedora-infra/ipsilon-fedora.git /opt/ipsilon-fedora \
    && cd /opt/ipsilon-fedora \
    && ./install.sh
# RUN ipsilon-server-install \
# 	--root-instance \
# 	--secure no \
# 	--hostname $hostname \
# 	--testauth yes \
# 	--testauth-groups "fedora-contributors,packager" \
# 	--openid yes \
# 	--openidc yes \
# 	--gssapi yes \
#       --gssapi-httpd-keytab /etc/ipsilon/ipsilon.keytab \
#       --pam yes \
#       --info-sssd yes \
# 	--openid-extensions "insecureAPI,Teams,CLAs,Simple Registration" \
# 	--openidc-extensions "fedora-account,waiverdb" \
# 	--openidc-default-attribute-mapping '[["*", "*"], ["_groups", "groups"], [["_extras", "cla"], "cla"], ["fullname", "name"], ["_username", "nickname"], ["_username", "preferred_username"], ["fasIRCNick", "ircnick"], ["fasLocale", "locale"], ["fasTimeZone", "zoneinfo"], ["fasTimeZone", "timezone"], ["fasWebsiteURL", "website"], ["fasGPGKeyId", "gpg_keyid"], ["ipaSshPubKey", "ssh_key"], ["fasIsPrivate", "privacy"], ["fullname", "human_name"]]'

# RUN sscg \
#     --ca-file /etc/pki/tls/certs/localhost-ca.crt \
#     --cert-file /etc/pki/tls/certs/localhost.crt \
#     --cert-key-file /etc/pki/tls/private/localhost.key \
#     --hostname $hostname \
#     --subject-alt-name id.tinystage.test \
#     --subject-alt-name ipsilon


COPY krb5_ccache_file.conf /etc/krb5.conf.d/ccache_file

RUN mkdir -p /conf/ipsilon /conf/certs && \
    ln -sf /conf/ipsilon /etc/ipsilon && \
    ln -sf /conf/certs/httpd.crt /etc/pki/tls/certs/localhost.crt && \
    ln -sf /conf/certs/httpd.key /etc/pki/tls/private/localhost.key && \
    mkdir -p /data/ipsilon && \
    ln -sf /data/ipsilon /var/lib/ipsilon


COPY journald-storage.conf /usr/lib/systemd/journald.conf.d/storage.conf
COPY httpd.conf.patch /tmp/httpd.conf.patch
RUN  cd /etc/httpd && patch -p0 -F 0 -i /tmp/httpd.conf.patch

# Don't call hostnamectl
#RUN mv /usr/bin/hostnamectl /usr/bin/hostnamectl.orig
#RUN ln -s true /usr/bin/hostnamectl

# # Apache logs to stdout
# RUN ln -sf /proc/self/fd/1 /var/log/httpd/access_log && \
#     ln -sf /proc/self/fd/1 /var/log/httpd/error_log

# COPY devel/ci/integration/ipsilon/setup-bodhi.py.tmpl /tmp/setup-bodhi.py.tmpl
# RUN sed -e "s|##REDIRECT##|$redirect|g" -e "s,##CLIENTURI##,$clienturi,g" /tmp/setup-bodhi.py.tmpl > /usr/local/bin/setup-bodhi.py && chmod ugo+x /usr/local/bin/setup-bodhi.py
#RUN python3 /usr/local/bin/setup-bodhi.py
RUN systemctl enable httpd.service
COPY start.sh /usr/local/bin/start.sh
COPY install.sh /usr/local/bin/install.sh
EXPOSE 80 443
RUN systemctl enable httpd.service
VOLUME /conf /data /tmp /run
CMD /usr/local/bin/start.sh
